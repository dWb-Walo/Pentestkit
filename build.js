import { createRequire } from 'module'
const require = createRequire(import.meta.url)
const file_system = require('fs')
let archiver = require('archiver')
let request = require('request')

if (!file_system.existsSync('dist')) {
    file_system.mkdirSync('dist');
}

let categories = {}

request.get(`https://raw.githubusercontent.com/AliasIO/wappalyzer/master/src/categories.json`, function (error, response, body) {
    categories = JSON.parse(body)
})
await new Promise(resolve => { setTimeout(resolve, 100) })

let technologies = {}

for (const index of Array(27).keys()) {
    const character = index ? String.fromCharCode(index + 96) : '_'
    request.get(`https://raw.githubusercontent.com/AliasIO/wappalyzer/master/src/technologies/${character}.json`, function (error, response, body) {
        technologies = {
            ...technologies,
            ...JSON.parse(body)
        }
    })
    await new Promise(resolve => { setTimeout(resolve, 300) })
}

file_system.writeFileSync('src/ptk/packages/wappalyzer/technologies.json', JSON.stringify({ categories: categories, technologies: technologies }, null, 4))



let manifestChrome = JSON.parse(file_system.readFileSync('src/manifest.json', 'utf8'))
let manifestFirefox = JSON.parse(file_system.readFileSync('src/manifest2.json', 'utf8'))
file_system.unlinkSync('src/manifest2.json')

// Chrome
let output = file_system.createWriteStream('dist/chrome_' + manifestChrome.version + '.zip')
let archive = archiver('zip')
output.on('close', function () {
    console.log(archive.pointer() + ' total bytes')
    console.log('archiver has been finalized and the output file descriptor has closed.')
})
archive.on('error', function (err) {
    throw err
})

archive.pipe(output)
archive.directory('src/', false)
archive.finalize()

await new Promise(resolve => {
    setTimeout(resolve, 3000)
})


// Firefox
file_system.writeFileSync('src/manifest.json', JSON.stringify(manifestFirefox, null, 4))
output = file_system.createWriteStream('dist/firefox_' + manifestFirefox.version + '.zip')
archive = archiver('zip')
output.on('close', function () {
    console.log(archive.pointer() + ' total bytes')
    console.log('archiver has been finalized and the output file descriptor has closed.')
})
archive.on('error', function (err) {
    throw err
})
archive.pipe(output)
archive.directory('src/', false)
archive.finalize()

await new Promise(resolve => {
    setTimeout(resolve, 3000)
})

file_system.writeFileSync('src/manifest.json', JSON.stringify(manifestChrome, null, 4))
file_system.writeFileSync('src/manifest2.json', JSON.stringify(manifestFirefox, null, 4))

